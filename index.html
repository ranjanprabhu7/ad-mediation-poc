<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Ad Mediation POC</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
      }

      #adContainer {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      #playAdBtn {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 18px;
        cursor: pointer;
      }

      #content {
        opacity: 0.3;
        pointer-events: none;
        transition: opacity 0.5s ease;
        max-width: 700px;
        margin: 60px auto;
        padding: 0 20px;
      }

      #content.unlocked {
        opacity: 1;
        pointer-events: auto;
      }
    </style>
  </head>
  <body>
    <!-- üé¨ Ad container -->
    <div id="adContainer">
      <div id="ima-video"></div>
      <button id="playAdBtn">‚ñ∂Ô∏è Start Ad</button>
    </div>

    <!-- üì∞ Blog content -->
    <div id="content">
      <h1>üöÄ Ad Mediation Demo</h1>
      <p>This article will unlock after the ad plays.</p>
      <p>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nulla facilisi.
        Donec sit amet orci non nulla gravida hendrerit.
      </p>
    </div>

    <!-- ‚úÖ Google IMA SDK -->
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>

    <script>
      const adContainer = document.getElementById("adContainer");
      const content = document.getElementById("content");
      const playAdBtn = document.getElementById("playAdBtn");

      let adDisplayContainer;
      let adsLoader;
      let adsManager;

      function initAd() {
        const videoElement = document.createElement("video");
        videoElement.setAttribute("playsinline", "");
        videoElement.setAttribute("autoplay", "");
        videoElement.setAttribute("controls", "");
        videoElement.style.width = "640px";
        videoElement.style.height = "360px";
        videoElement.muted = true; // üëà Required for autoplay

        document.getElementById("ima-video").appendChild(videoElement);

        adDisplayContainer = new google.ima.AdDisplayContainer(
          adContainer,
          videoElement
        );
        adDisplayContainer.initialize();

        const adsRequest = new google.ima.AdsRequest();
        adsRequest.adTagUrl = "https://pubads.g.doubleclick.net/gampad/ads?iu=/21775744923/external/single_ad_samples&sz=640x480&cust_params=deployment%3Ddevsite%26sample_ct%3Dlinear&gdfp_req=1&output=vast&unviewed_position_start=1&env=vp&impl=s&correlator=" + Date.now();

        adsRequest.linearAdSlotWidth = 640;
        adsRequest.linearAdSlotHeight = 360;
        adsRequest.nonLinearAdSlotWidth = 640;
        adsRequest.nonLinearAdSlotHeight = 150;

        adsLoader = new google.ima.AdsLoader(adDisplayContainer);

        adsLoader.addEventListener(
          google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,
          (e) => {
            adsManager = e.getAdsManager(videoElement);

            adsManager.addEventListener(
              google.ima.AdEvent.Type.ALL_ADS_COMPLETED,
              () => {
                adContainer.style.display = "none";
                content.classList.add("unlocked");
              }
            );

            adsManager.addEventListener(
              google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,
              () => {
                adContainer.style.display = "none";
                content.classList.add("unlocked");
              }
            );

            try {
              adsManager.init(640, 360, google.ima.ViewMode.NORMAL);
              adsManager.start();
            } catch (err) {
              console.warn("Ad start error:", err);
              adContainer.style.display = "none";
              content.classList.add("unlocked");
            }
          }
        );

        adsLoader.addEventListener(
          google.ima.AdErrorEvent.Type.AD_ERROR,
          (err) => {
            console.warn("Ad error:", err.getError());
            adContainer.style.display = "none";
            content.classList.add("unlocked");
          }
        );

        adsLoader.requestAds(adsRequest);
      }

      playAdBtn.addEventListener("click", () => {
        playAdBtn.style.display = "none";
        initAd();
      });
    </script>
  </body>
</html>
